<div class="container">
  <div class="row">
    <div class="col-10 offset-1 mb-3">
      <h2 class="mt-3 fw-bold">Cycling Map</h2>
      <p>走る地域の周辺情報を探してみましょう！</p>
      <!--検索フォーム-->
      <div class="d-flex">
        
      <input id="address" type="textbox" placeholder="地名・場所">
      <input type="button" value="検索" onclick="codeAddress()">
      <div class="ms-auto">
        <%= link_to search_posts_path, class:"link-secondary" do %>
          <i class="fas fa-external-link-alt me-1"></i><span>詳細検索</span>
        <% end %>
      </div>
      </div>
      <!--地図-->
      <div class="border mt-3">
        <div id="map"></div>
        <style>
          #map{
              height: 600px;
          }
        </style>
        <script type="text/javascript">
          let map;
          let geocoder;
          let marker = []; //マーカーの配列化
          let infoWindow = []; //吹き出しの配列化
          let markerInfo = gon.posts;

          function initMap(){
            geocoder = new google.maps.Geocoder()
            map = new google.maps.Map(document.getElementById('map'), {
              center: {lat: 35.678, lng: 139.765},
              zoom: 13
            });

            var bikeLayer = new google.maps.BicyclingLayer();
            bikeLayer.setMap(map);

            for (let i = 0; i < markerInfo.length; i++) {
              //投稿のidを変数に指定
              let id = markerInfo[i]['id']

              // 投稿の緯度経度を取り出す
              markerLatLng = new google.maps.LatLng({
                lat: markerInfo[i]['latitude'],
                lng: markerInfo[i]['longitude']
              });

              // 各投稿のマーカー作成
              marker[i] = new google.maps.Marker({
                position: markerLatLng,
                map: map
              });

              // 各投稿の吹き出しを作成
              contentString = `<h6><a href='/posts/${ id }'>${markerInfo[i]['title']}</a></h6>` +
                `<p>${markerInfo[i]['genre']}</p>`;

              infoWindow[i] = new google.maps.InfoWindow({
                content: contentString
              });

              marker[i].addListener('click', function(){
                infoWindow[i].open(map, marker[i]);
              });
            }
          }

          // 検索結果
          function codeAddress(){
            let inputAddress = document.getElementById('address').value;

            geocoder.geocode( { 'address': inputAddress}, function(results, status) {
              if (status == 'OK') {
                map.setCenter(results[0].geometry.location);
              } else {
                alert('該当結果がありません。違う地名で検索しましょう！');
              }
            });
          }
        </script>
        <script async defer
          src="https://maps.googleapis.com/maps/api/js?language=ja&v=3.exp&key=<%= ENV['GOOGLE_MAP_API_KEY'] %>&callback=initMap">
        </script>
      </div>
    </div>
  </div>
</div>